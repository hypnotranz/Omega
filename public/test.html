<!DOCTYPE html>
<html>
<head>
  <title>Debug Test</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #0f0; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
    pre { background: #000; padding: 10px; white-space: pre-wrap; max-height: 400px; overflow: auto; }
    .success { color: #0f0; }
    .error { color: #f00; }
  </style>
</head>
<body>
  <h1>OmegaLLM Debug Test</h1>

  <div>
    <button onclick="testHealth()">1. Test Health</button>
    <button onclick="testSession()">2. Create Session</button>
    <button onclick="testLoad()">3. Load Code</button>
    <button onclick="testStep()">4. Step</button>
    <button onclick="testRunLLM()">5. Run LLM</button>
  </div>

  <h3>Session: <span id="session">none</span></h3>
  <h3>Status: <span id="status">-</span></h3>

  <h3>Output:</h3>
  <pre id="output">Click buttons above to test...</pre>

  <script>
    let sessionId = null;
    const output = document.getElementById('output');
    const sessionEl = document.getElementById('session');
    const statusEl = document.getElementById('status');

    function log(msg, isError) {
      const line = document.createElement('div');
      line.className = isError ? 'error' : 'success';
      line.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    async function testHealth() {
      log('Testing /health...');
      try {
        const res = await fetch('http://localhost:3456/health');
        const data = await res.json();
        log('Health: ' + JSON.stringify(data));
        statusEl.textContent = 'Server OK';
      } catch (e) {
        log('ERROR: ' + e.message, true);
        statusEl.textContent = 'Server DOWN';
      }
    }

    async function testSession() {
      log('Creating session...');
      try {
        const res = await fetch('http://localhost:3456/session', { method: 'POST' });
        const data = await res.json();
        sessionId = data.sessionId;
        sessionEl.textContent = sessionId;
        log('Session created: ' + sessionId);
      } catch (e) {
        log('ERROR: ' + e.message, true);
      }
    }

    async function testLoad() {
      if (!sessionId) { log('Create session first!', true); return; }

      const code = '(+ 1 2)';
      log('Loading: ' + code);

      try {
        const res = await fetch(`http://localhost:3456/session/${sessionId}/load`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });
        const data = await res.json();
        log('Load result: ' + JSON.stringify(data));
      } catch (e) {
        log('ERROR: ' + e.message, true);
      }
    }

    async function testStep() {
      if (!sessionId) { log('Create session first!', true); return; }

      log('Stepping...');
      try {
        const res = await fetch(`http://localhost:3456/session/${sessionId}/step`, { method: 'POST' });
        const data = await res.json();
        log('Step result:');
        log({
          control: data.snapshot?.control,
          status: data.snapshot?.status,
          outcome: data.outcome
        });
      } catch (e) {
        log('ERROR: ' + e.message, true);
      }
    }

    async function testRunLLM() {
      if (!sessionId) { log('Create session first!', true); return; }

      const code = '(effect "opr.step.opr.classify.v1" (list "bug crash" (list "bug" "feature")))';
      log('Loading LLM code: ' + code);

      try {
        // Load
        await fetch(`http://localhost:3456/session/${sessionId}/load`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        log('Running with LLM (this takes ~5 seconds)...');
        const res = await fetch(`http://localhost:3456/session/${sessionId}/run-async`, { method: 'POST' });
        const data = await res.json();

        log('LLM Result:');
        if (data.effectLog && data.effectLog.length > 0) {
          const effect = data.effectLog[0];
          log({
            operation: effect.op,
            duration: effect.duration + 'ms',
            result: effect.result
          });
        } else {
          log(data);
        }
      } catch (e) {
        log('ERROR: ' + e.message, true);
      }
    }
  </script>
</body>
</html>
