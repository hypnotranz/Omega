# Job 017: CLI Unification - Beads Feature Definition
#
# Import with: python ../codesmith/cli.py import CLAUDE-JOBS/017-features.yaml
# Run with:    python ../codesmith/cli.py run --max-workers 2

project:
  name: "OmegaLLM CLI Unification"
  description: "Unify omega-repl and omega-debugger into single 'omega' command"

features:
  # ═══════════════════════════════════════════════════════════════════════════
  # Track 1: File Loader (Independent - can run immediately)
  # ═══════════════════════════════════════════════════════════════════════════
  - id: cli-file-loader-fix
    title: "Fix file loader for multi-line S-expressions"
    type: implementation
    requirements: "CLAUDE-JOBS/017a-FILE-LOADER-FIX.md"
    acceptance_criteria:
      - "Bug at bin/omega-repl.ts:2057 is fixed"
      - "File loader uses extractSexpressions() instead of split('\\n')"
      - "Comment lines are stripped before parsing"
      - "Test: npx tsx bin/omega-repl.ts --file demo/lisp/ch03-composition.lisp runs without syntax errors"
      - "Test: Multi-line define expressions parse correctly"
      - "Test: Single-line files still work"

  # ═══════════════════════════════════════════════════════════════════════════
  # Track 2: Public API (Independent - can run immediately)
  # ═══════════════════════════════════════════════════════════════════════════
  - id: cli-public-api
    title: "Extend public API for CLI tools"
    type: implementation
    requirements: "CLAUDE-JOBS/017b-PUBLIC-API-EXTENSION.md"
    acceptance_criteria:
      - "src/index.ts has new 'CLI TOOLS - CEKS Machine' section"
      - "Exports added: COWStore, Store, stepOnce, StepResult"
      - "Exports added: runToCompletionWithState, runToCompletion"
      - "Exports added: State, Frame, Env types"
      - "Exports added: compileTextToExpr, RuntimeImpl"
      - "Exports added: SnapshotRepo, InMemoryReceiptStore, ReceiptStore"
      - "Exports added: createOpenAIAdapter, installPrims"
      - "Test: npx tsc --noEmit passes"
      - "Test: Test consumer file can import all new exports"

  # ═══════════════════════════════════════════════════════════════════════════
  # Track 3: Merge Commands (Independent - can run immediately)
  # ═══════════════════════════════════════════════════════════════════════════
  - id: cli-merge-commands
    title: "Merge debugger commands into REPL"
    type: implementation
    requirements: "CLAUDE-JOBS/017c-MERGE-DEBUGGER-COMMANDS.md"
    acceptance_criteria:
      - "ReplState has 'snapshots' Map field"
      - "ReplState has 'recordingEnabled' boolean field"
      - "Command :dump <path> saves trace to JSON"
      - "Command :replay <path> loads and re-executes trace"
      - "Command :snapshot <name> saves named state"
      - "Command :restore <name> restores named state"
      - "Command :snapshots lists all saved snapshots"
      - "Command :record on/off toggles recording"
      - "Command :history [n] shows last n steps"
      - ":help output includes all 7 new commands"
      - "Test: :dump creates valid JSON file"
      - "Test: :snapshot/:restore roundtrip works"
      - "Test: :history shows current step marker"

  # ═══════════════════════════════════════════════════════════════════════════
  # Track 4: Final Unification (Depends on all above)
  # ═══════════════════════════════════════════════════════════════════════════
  - id: cli-unification
    title: "Final CLI unification - single omega command"
    type: implementation
    depends_on:
      - cli-file-loader-fix
      - cli-public-api
      - cli-merge-commands
    requirements: "CLAUDE-JOBS/017d-CLI-UNIFICATION.md"
    acceptance_criteria:
      - "bin/omega-repl.ts renamed to bin/omega.ts"
      - "bin/omega-debugger.ts deleted"
      - "bin/omega.ts header updated with new name and usage"
      - "All imports from ../src/core/ replaced with ../src"
      - "All imports from ../test/helpers/ replaced with ../src"
      - "package.json bin entry points to omega"
      - "Comprehensive --help implemented with all commands"
      - "Test: ls bin/*.ts shows only omega.ts"
      - "Test: grep 'from \"../src/core' bin/omega.ts returns nothing"
      - "Test: npx tsx bin/omega.ts --help shows full help"
      - "Test: npx tsx bin/omega.ts --cmd '(+ 1 2)' outputs 3"
      - "Test: npm test passes"
