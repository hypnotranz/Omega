# OmegaLLM Phase D: Architecture Alignment
# Jobs 009-015: FrameIR & Ports
#
# Import with: python ../codesmith/cli.py import features-phase-d.yaml

project:
  name: "OmegaLLM Phase D"
  description: "Architecture alignment - FrameIR, ports, replay, lints, compilation pipeline"

features:
  # === Job 009: FrameIR Package ===
  # Foundational - blocks all other Phase D jobs
  - id: frameir-package
    title: "FrameIR Package (@frameir)"
    type: implementation
    priority: critical
    requirements: "CLAUDE-JOBS/009-FRAMEIR-PACKAGE.md"
    acceptance_criteria:
      - "Create @frameir package with ValueIR, PromptIR, FlowIR types"
      - "Implement canonical JSON encoding (sorted keys, no NaN)"
      - "Add merkleization (content hashes)"
      - "Export all types from index.ts"
      - "All tests pass (npx vitest run test/frameir/)"

  # === Job 010: Primitive Registry ===
  - id: primitive-registry
    title: "Primitive Registry (PrimitiveDescriptor)"
    type: implementation
    priority: high
    depends_on: [frameir-package]
    requirements: "CLAUDE-JOBS/010-PRIMITIVE-REGISTRY.md"
    acceptance_criteria:
      - "Create PrimitiveDescriptor interface with all golden fields"
      - "Implement queryable registry with name lookups"
      - "Add effect descriptors for each primitive"
      - "Seed registry with core primitives"
      - "All tests pass (npx vitest run test/registry/)"

  # === Job 011: Port Abstractions ===
  - id: port-abstractions
    title: "Port Abstractions (Hexagonal)"
    type: implementation
    priority: high
    depends_on: [frameir-package]
    requirements: "CLAUDE-JOBS/011-PORT-ABSTRACTIONS.md"
    acceptance_criteria:
      - "Define port interfaces: OraclePort, ToolPort, StorePort, SinkPort, SourcePort, ClockPort, RngPort"
      - "Create LoggingAdapter decorator"
      - "Create ReplayAdapter decorator"
      - "Define CompositePort for multi-backend"
      - "All tests pass (npx vitest run test/ports/)"

  # === Job 012: Outcome/Failure/Diagnostic ===
  - id: outcome-failure-diagnostic
    title: "Outcome/Failure/Diagnostic ADTs"
    type: implementation
    priority: critical
    depends_on: [frameir-package]
    requirements: "CLAUDE-JOBS/012-OUTCOME-FAILURE-DIAGNOSTIC.md"
    acceptance_criteria:
      - "Define Outcome<T> = Ok<T> | Err<Failure>"
      - "Define Failure with structured codes"
      - "Define Diagnostic with span, severity, message"
      - "Add constructor helpers (ok, err, warn, etc.)"
      - "All tests pass (npx vitest run test/outcome/)"

  # === Job 013: Lint Passes ===
  - id: lint-passes
    title: "IR Lint Passes"
    type: implementation
    priority: high
    depends_on: [frameir-package, primitive-registry, outcome-failure-diagnostic]
    requirements: "CLAUDE-JOBS/013-LINT-PASSES.md"
    acceptance_criteria:
      - "Implement budgetDominator pass (check budget at all call sites)"
      - "Implement timeoutGuard pass (verify budget checks)"
      - "Implement toolContract pass (validate schemas)"
      - "Implement LintRunner to execute passes"
      - "All tests pass (npx vitest run test/lint/)"

  # === Job 014: Compilation Pipeline ===
  - id: compilation-pipeline
    title: "Compilation Pipeline"
    type: implementation
    priority: high
    depends_on: [frameir-package, outcome-failure-diagnostic, lint-passes]
    requirements: "CLAUDE-JOBS/014-COMPILATION-PIPELINE.md"
    acceptance_criteria:
      - "Implement reader (text -> S-expr)"
      - "Implement macroexpander (syntax-rules)"
      - "Implement lowerer (S-expr -> FlowIR)"
      - "Implement normalizer (ANF conversion)"
      - "Add source map support"
      - "All tests pass (npx vitest run test/compiler/)"

  # === Job 015: Replay System ===
  - id: replay-system
    title: "Replay System"
    type: implementation
    priority: high
    depends_on: [port-abstractions, outcome-failure-diagnostic, compilation-pipeline]
    requirements: "CLAUDE-JOBS/015-REPLAY-SYSTEM.md"
    acceptance_criteria:
      - "Define ReplayEvent types for each port interaction"
      - "Implement ReplayLog (append, serialize, deserialize)"
      - "Create replay adapters for all ports"
      - "Add determinism guards (detect non-deterministic divergence)"
      - "All tests pass (npx vitest run test/replay/)"
